<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labubu AR (å…¨è‡ªç”±åº¦ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #input-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        /* UI æ§ä»¶ */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #switch-btn {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            background: rgba(0, 0, 0, 0.5); color: white; border: 1px solid white;
            padding: 8px 16px; border-radius: 20px; font-size: 14px; display: none;
        }
        #debug {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.3); color: #00ff00; font-size: 10px;
            padding: 10px; pointer-events: none; box-sizing: border-box;
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 20; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #00C853; color: white;
            border: none; border-radius: 30px; font-weight: bold; margin-top: 20px; cursor: pointer;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="overlay">
        <h1>ğŸ‘‹ Labubu AR</h1>
        <div id="status">æ­£åœ¨å‡†å¤‡...</div>
        <button id="start-btn" disabled>åŠ è½½ä¸­...</button>
    </div>

    <div id="ui-container">
        <button id="switch-btn">ğŸ“· åˆ‡æ¢é•œå¤´</button>
        <div id="debug"></div>
    </div>

    <video id="input-video" playsinline webkit-playsinline></video>
    <canvas id="output-canvas"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        function log(msg) {
            const d = document.getElementById('debug');
            if(d) d.innerHTML = msg; 
            console.log(msg);
        }

        let camera, scene, renderer, labubuGroup;
        let hands, cameraUtils;
        let isFrontCamera = true;
        
        const videoElement = document.getElementById('input-video');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status');
        const overlay = document.getElementById('overlay');
        const switchBtn = document.getElementById('switch-btn');

        window.onload = () => {
            if(typeof Hands === 'undefined') {
                statusText.innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°";
            } else {
                statusText.innerText = "èµ„æºå°±ç»ª";
                startBtn.innerText = "ç‚¹å‡»å¯åŠ¨";
                startBtn.disabled = false;
            }
        };

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.innerText = "å¯åŠ¨ä¸­...";
            try {
                initThree();
                initAI();
                await startCamera('user');
                overlay.style.display = 'none';
                switchBtn.style.display = 'block';
            } catch (e) {
                alert("é”™è¯¯: " + e.message);
                startBtn.disabled = false;
            }
        });

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5; 

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('output-canvas'), alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(2, 5, 5);
            scene.add(dirLight);

            labubuGroup = new THREE.Group();
            scene.add(labubuGroup);

            // å ä½æ–¹å— (15cm)
            const box = new THREE.Mesh(
                new THREE.BoxGeometry(0.15, 0.15, 0.15), 
                new THREE.MeshNormalMaterial()
            );
            labubuGroup.add(box);

            // åŠ è½½ Labubu
            const loader = new GLTFLoader();
            const modelUrl = 'https://raw.githubusercontent.com/yannluo/labubu-ar/main/labubu.glb'; 
            
            loader.load(modelUrl, (gltf) => {
                labubuGroup.remove(box); 
                const model = gltf.scene;
                model.scale.set(0.08, 0.08, 0.08); 
                
                // ä¿®æ­£æ¨¡å‹æœå‘ï¼šé€šå¸¸æ¨¡å‹æ˜¯é¢æœ +Z çš„ï¼Œæˆ‘ä»¬éœ€è¦è®©å®ƒèƒŒå¯¹ +Z (é¢æœæ‘„åƒæœº)
                // å¦‚æœä½ çš„æ¨¡å‹åŠ è½½å‡ºæ¥æ˜¯å±è‚¡å¯¹ç€ä½ ï¼ŒæŠŠ y æ—‹è½¬ 180åº¦ (Math.PI)
                // model.rotation.y = Math.PI; 
                
                model.position.y = -0.3; 
                labubuGroup.add(model);
                log("æ¨¡å‹å·²åŠ è½½");
            }, undefined, (e) => {
                log("æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ–¹å—");
            });
        }

        function initAI() {
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            hands.onResults(onResults);
        }

        async function startCamera(mode) {
            if (cameraUtils) await cameraUtils.stop();
            const scaleX = mode === 'user' ? -1 : 1;
            videoElement.style.transform = `scaleX(${scaleX})`;
            
            cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720, facingMode: mode
            });
            await cameraUtils.start();
        }

        switchBtn.addEventListener('click', async () => {
            switchBtn.disabled = true;
            isFrontCamera = !isFrontCamera;
            await startCamera(isFrontCamera ? 'user' : 'environment');
            switchBtn.disabled = false;
        });

        function onResults(results) {
            renderer.clear();
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                let x = landmarks[9].x; // ä¸­æŒ‡æ ¹
                let y = landmarks[9].y;
                
                // å‰ç½®é•œåƒå¤„ç†
                if (isFrontCamera) x = 1 - x;

                // --- 1. è®¡ç®—ä½ç½® (Position) ---
                const vec = new THREE.Vector3();
                vec.set((x * 2) - 1, -(y * 2) + 1, 0.5);
                vec.unproject(camera);
                vec.sub(camera.position).normalize();

                // è·ç¦»è®¡ç®— (ç¦»è¿‘å˜å¤§ï¼Œç¦»è¿œå˜å°)
                const dx = landmarks[0].x - landmarks[9].x;
                const dy = landmarks[0].y - landmarks[9].y;
                const handSize = Math.sqrt(dx*dx + dy*dy);
                
                const depthFactor = isFrontCamera ? 6 : 9; 
                let distance = 1 / (handSize * depthFactor);
                if (distance < 1.5) distance = 1.5; // æœ€è¿‘è·ç¦»é™åˆ¶
                if (distance > 8) distance = 8;     // æœ€è¿œè·ç¦»é™åˆ¶

                const finalPos = vec.multiplyScalar(distance).add(camera.position);
                labubuGroup.position.copy(finalPos);

                // --- 2. è®¡ç®—æ—‹è½¬ (Rotation) ---
                // è¿™é‡Œçš„æ ¸å¿ƒæ˜¯ï¼šä¸å†ä½¿ç”¨ lookAtï¼Œè€Œæ˜¯æ ¹æ®æ‰‹çš„è§’åº¦æ¥è®¾å®šæ—‹è½¬
                
                // 2.1 Zè½´æ—‹è½¬ (å·¦å³æ­ªå¤´)
                // è®¡ç®—æ‰‹è…•(0)åˆ°ä¸­æŒ‡(9)çš„å‘é‡è§’åº¦
                let angleZ = Math.atan2(
                    landmarks[9].y - landmarks[0].y, 
                    landmarks[9].x - landmarks[0].x
                );
                
                // å‰ç½®æ‘„åƒå¤´å› ä¸ºé•œåƒï¼Œæ—‹è½¬è§’åº¦è¦å–å
                if (isFrontCamera) {
                    angleZ = -angleZ; 
                    angleZ = Math.PI - angleZ; // ä¿®æ­£é•œåƒåçš„åæ ‡ç³»
                }

                // è®¾ç½® Z è½´æ—‹è½¬ (æ³¨æ„ï¼šæ‰‹è…•å‘ä¸‹æ˜¯ +90åº¦ï¼Œæ‰€ä»¥è¦å‡å» 90åº¦ä¿®æ­£)
                labubuGroup.rotation.z = -angleZ + (Math.PI / 2);

                // 2.2 Xè½´/Yè½´ (ç®€å•çš„è·Ÿéš)
                // ä¸ºäº†è®©æ¨¡å‹ç¨³ç¨³ååœ¨æ‰‹ä¸Šï¼Œæˆ‘ä»¬ç»™å®ƒä¸€ä¸ªå›ºå®šçš„ X è½´ä»°è§’ (ç¨å¾®ä»°è§†)
                // è¿™æ ·çœ‹èµ·æ¥åƒæ˜¯ååœ¨ä½ å€¾æ–œçš„æ‰‹æŒä¸Š
                labubuGroup.rotation.x = -Math.PI / 6; 
                
                // 2.3 å·¦å³è½¬åŠ¨ (Yè½´)
                // ç®€å•ç®—æ³•ï¼šæ ¹æ®æ‰‹åœ¨å±å¹•å·¦å³çš„ä½ç½®ï¼Œç¨å¾®è½¬åŠ¨ä¸€ç‚¹èº«ä½“ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ
                labubuGroup.rotation.y = (x - 0.5) * 1.5;

                labubuGroup.visible = true;

            } else {
                labubuGroup.position.set(0, 0, -3); 
                labubuGroup.visible = true;
                labubuGroup.rotation.y += 0.02;
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
