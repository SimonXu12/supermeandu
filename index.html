<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labubu AR (æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* è§†é¢‘å’Œç”»å¸ƒå±‚å  */
        #input-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }

        /* UI ç•Œé¢ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’® (å³ä¸Šè§’) */
        #switch-btn {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            background: rgba(0, 0, 0, 0.5); color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px; border-radius: 20px; font-size: 14px;
            backdrop-filter: blur(4px);
        }

        /* å¯åŠ¨é®ç½© */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; pointer-events: auto;
        }
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #00C853; color: white;
            border: none; border-radius: 30px; font-weight: bold; cursor: pointer;
            margin-top: 20px;
        }
        #status-text { margin-top: 10px; color: #aaa; font-size: 14px; }
        
        /* è°ƒè¯•æ—¥å¿— */
        #debug {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.5); color: lime; font-size: 12px;
            padding: 10px; pointer-events: none; overflow: hidden;
        }
    </style>

    <script src="https://cdn.staticfile.org/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

    <div id="overlay">
        <h1>ğŸ‘‹ Labubu AR</h1>
        <div id="status-text">æ­£åœ¨å‡†å¤‡èµ„æº...</div>
        <button id="start-btn" disabled>åŠ è½½ä¸­...</button>
    </div>

    <div id="ui-layer">
        <button id="switch-btn" style="display:none;">ğŸ“· åˆ‡æ¢æ‘„åƒå¤´</button>
        <div id="debug"></div>
    </div>

    <video id="input-video" playsinline webkit-playsinline></video>
    <canvas id="output-canvas"></canvas>

    <script>
        // --- æç®€æ—¥å¿—ç³»ç»Ÿ ---
        function log(msg) {
            console.log(msg);
            const d = document.getElementById('debug');
            d.innerHTML = msg + '<br>' + d.innerHTML;
        }

        // --- æ ¸å¿ƒå˜é‡ ---
        let camera, scene, renderer, labubuGroup;
        let hands, cameraUtils;
        let isFrontCamera = true; // é»˜è®¤å‰ç½®
        
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const switchBtn = document.getElementById('switch-btn');
        const overlay = document.getElementById('overlay');

        // --- 1. åˆå§‹åŒ– (é¡µé¢åŠ è½½å³è¿è¡Œ) ---
        window.onload = () => {
            log("ç³»ç»Ÿå¯åŠ¨ï¼Œæ£€æŸ¥ç¯å¢ƒ...");
            if (typeof THREE === 'undefined' || typeof Hands === 'undefined') {
                statusText.innerText = "èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•";
                statusText.style.color = 'red';
                return;
            }
            statusText.innerText = "ç¯å¢ƒå°±ç»ª";
            startBtn.innerText = "ç‚¹å‡»å¯åŠ¨";
            startBtn.disabled = false;
        };

        // --- 2. ç‚¹å‡»å¯åŠ¨ ---
        startBtn.onclick = async () => {
            startBtn.disabled = true;
            startBtn.innerText = "å¯åŠ¨ä¸­...";
            
            try {
                // A. åˆå§‹åŒ– 3D
                initThree();
                
                // B. åˆå§‹åŒ– AI
                initAI();

                // C. å¯åŠ¨æ‘„åƒå¤´
                await startCamera('user');

                // D. æˆåŠŸè¿›å…¥
                overlay.style.display = 'none';
                switchBtn.style.display = 'block';
                
            } catch (e) {
                log("âŒ å¯åŠ¨å¤±è´¥: " + e.message);
                alert("å¯åŠ¨å¤±è´¥: " + e.message);
                startBtn.disabled = false;
            }
        };

        // --- 3. Three.js è®¾ç½® ---
        function initThree() {
            log("åŠ è½½ 3D å¼•æ“...");
            scene = new THREE.Scene();
            
            // ç›¸æœºè®¾ç½®
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ canvas: canvasElement, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // ç¯å…‰
            scene.add(new THREE.AmbientLight(0xffffff, 1.0));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // æ¨¡å‹ç»„
            labubuGroup = new THREE.Group();
            scene.add(labubuGroup);

            // >>> åŠ è½½ Labubu æ¨¡å‹ (ä½¿ç”¨ GitHub æº) <<<
            const loader = new THREE.GLTFLoader();
            const modelUrl = 'https://raw.githubusercontent.com/yannluo/labubu-ar/main/labubu.glb'; 
            // æ³¨æ„ï¼šå¦‚æœè¿™ä¸ª URL è®¿é—®æ…¢ï¼Œä½ å¯ä»¥æŠŠæœ¬åœ°çš„ labubu.glb å’Œ index.html æ”¾ä¸€èµ·ï¼Œæ”¹æˆ './labubu.glb'
            
            loader.load(modelUrl, (gltf) => {
                const model = gltf.scene;
                // è°ƒæ•´å¤§å°ï¼šå¦‚æœæ¨¡å‹å¤ªå¤§ï¼ŒæŠŠ 0.5 æ”¹å°ï¼›å¦‚æœå¤ªå°ï¼Œæ”¹å¤§
                model.scale.set(0.3, 0.3, 0.3); 
                model.position.y = -1; // è°ƒæ•´å‚ç›´ä½ç½®
                labubuGroup.add(model);
                log("âœ… Labubu æ¨¡å‹å·²åŠ è½½");
            }, undefined, (err) => {
                log("âš ï¸ æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨çº¢è‰²æ–¹å—ä»£æ›¿");
                const box = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 1, 1),
                    new THREE.MeshNormalMaterial()
                );
                labubuGroup.add(box);
            });
        }

        // --- 4. AI è®¾ç½® ---
        function initAI() {
            log("åŠ è½½ AI æ¨¡å‹...");
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // 0=Lite (æœ€å¿«), 1=Full
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onResults);
        }

        // --- 5. æ‘„åƒå¤´é€»è¾‘ (å«åˆ‡æ¢) ---
        async function startCamera(mode) {
            log(`è¯·æ±‚æ‘„åƒå¤´: ${mode}`);
            if (cameraUtils) await cameraUtils.stop();

            // é•œåƒå¤„ç†ï¼šå‰ç½®éœ€è¦ç¿»è½¬ï¼Œåç½®ä¸éœ€è¦
            const scaleX = mode === 'user' ? -1 : 1;
            videoElement.style.transform = `scaleX(${scaleX})`;
            // æ³¨æ„ï¼šCanvas ä¸ç¿»è½¬ï¼Œæˆ‘ä»¬é€šè¿‡è®¡ç®—åæ ‡æ¥ç¿»è½¬
            
            cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720,
                facingMode: mode
            });
            
            await cameraUtils.start();
            log("âœ… æ‘„åƒå¤´ç”»é¢å·²è·å–");
        }

        // åˆ‡æ¢æŒ‰é’®äº‹ä»¶
        switchBtn.onclick = async () => {
            switchBtn.disabled = true;
            isFrontCamera = !isFrontCamera;
            const mode = isFrontCamera ? 'user' : 'environment';
            switchBtn.innerText = "åˆ‡æ¢ä¸­...";
            try {
                await startCamera(mode);
                switchBtn.innerText = isFrontCamera ? "ğŸ“· åˆ‡åˆ°åç½®" : "ğŸ“· åˆ‡åˆ°å‰ç½®";
            } catch(e) {
                log("åˆ‡æ¢å¤±è´¥");
            }
            switchBtn.disabled = false;
        };

        // --- 6. æ¸²æŸ“å¾ªç¯ (æ¯ä¸€å¸§) ---
        function onResults(results) {
            // æ¸…ç©ºç”»å¸ƒï¼Œå‡†å¤‡ç”» 3D
            renderer.clear(); // é‡è¦ï¼
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // 1. æ‰¾åˆ°æ‰‹æŒä¸­å¿ƒ (ä¸­æŒ‡æ ¹éƒ¨)
                let x = landmarks[9].x;
                let y = landmarks[9].y;
                
                // 2. å¦‚æœæ˜¯å‰ç½®æ‘„åƒå¤´ï¼ŒXè½´éœ€è¦åè½¬ (å› ä¸ºç”»é¢æ˜¯é•œåƒçš„)
                if (isFrontCamera) {
                    x = 1 - x; 
                }

                // 3. è½¬æ¢åˆ° 3D åæ ‡
                const vec = new THREE.Vector3();
                vec.set(
                    (x * 2) - 1,  // x: -1 åˆ° 1
                    -(y * 2) + 1, // y: -1 åˆ° 1
                    0.5           // æ·±åº¦
                );
                vec.unproject(camera);
                vec.sub(camera.position).normalize();

                // 4. ä¼°ç®—è·ç¦» (è®©æ¨¡å‹çœ‹èµ·æ¥åœ¨æ‰‹ä¸Š)
                // åç½®æ‘„åƒå¤´é€šå¸¸ç¦»å¾—è¿œï¼Œæ·±åº¦ç³»æ•°è¦å¤§ä¸€ç‚¹
                const depthFactor = isFrontCamera ? 5 : 8; 
                
                // è®¡ç®—æ‰‹çš„å¤§å° (æ‰‹è…•åˆ°ä¸­æŒ‡)
                const dx = landmarks[0].x - landmarks[9].x;
                const dy = landmarks[0].y - landmarks[9].y;
                const handSize = Math.sqrt(dx*dx + dy*dy);
                
                const distance = 1 / (handSize * depthFactor);
                
                const finalPos = vec.multiplyScalar(distance).add(camera.position);
                
                // 5. æ›´æ–°æ¨¡å‹ä½ç½®
                labubuGroup.position.copy(finalPos);
                labubuGroup.visible = true;
                
                // (å¯é€‰) å¦‚æœä½ æƒ³è®©æ¨¡å‹é¢å‘ç›¸æœºï¼Œè§£å¼€ä¸‹é¢è¿™è¡Œ
                // labubuGroup.lookAt(camera.position); 

            } else {
                // æ²¡æ£€æµ‹åˆ°æ‰‹æ—¶çš„å¤„ç†
                // æ–¹æ¡ˆ A: éšè—æ¨¡å‹ (æœ€ç¨³å¦¥)
                // labubuGroup.visible = false; 

                // æ–¹æ¡ˆ B: è®©ä»–æµ®åœ¨å±å¹•ä¸­é—´ (ä¸ºäº†è®©ä½ çŸ¥é“å®ƒè¿˜åœ¨)
                 labubuGroup.position.set(0, 0, 0); // å½’é›¶
                 labubuGroup.visible = true;
                 // è®©å®ƒåœ¨å±å¹•ä¸­å¿ƒç¨å¾®è¿œä¸€ç‚¹çš„åœ°æ–¹
                 const centerVec = new THREE.Vector3(0, 0, -2).applyMatrix4(camera.matrixWorld);
                 labubuGroup.position.copy(centerVec);
                 labubuGroup.rotation.y += 0.01; // æ²¡æ‰‹çš„æ—¶å€™è‡ªè½¬ä¸€ä¸‹ï¼Œè¯æ˜æ²¡æ­»æœº
            }

            renderer.render(scene, camera);
        }

        // çª—å£é€‚é…
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
