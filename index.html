<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labubu AR (å›½å†…åŠ é€Ÿç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #input-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; transform: scaleX(-1); }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; transform: scaleX(-1); }
        
        /* é®ç½©å±‚ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }

        /* æŒ‰é’® */
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #00C853; color: white;
            border: none; border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4); margin-bottom: 20px;
        }
        #start-btn:disabled { background: #555; color: #888; box-shadow: none; }

        /* åˆ‡æ¢æŒ‰é’® */
        #switch-btn {
            position: absolute; top: 20px; right: 20px; z-index: 99;
            background: rgba(255, 255, 255, 0.3); color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
            display: none; backdrop-filter: blur(5px);
        }

        /* è°ƒè¯•æ—¥å¿— */
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.6); color: #00ff00; font-size: 11px; 
            padding: 10px; overflow-y: scroll; z-index: 101; pointer-events: none;
            font-family: monospace; border-top: 1px solid #333;
        }
    </style>
    
    <script src="https://cdn.staticfile.org/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

    <button id="switch-btn">ğŸ“· åˆ‡æ¢æ‘„åƒå¤´</button>

    <div id="overlay">
        <h1>ğŸ‘‹ Labubu AR</h1>
        <div id="loading-status" style="margin: 20px 0; color: #aaa;">è¿æ¥èµ„æºæœåŠ¡å™¨...</div>
        <button id="start-btn" disabled>åŠ è½½ä¸­...</button>
    </div>

    <div id="debug-log">System Init...</div>
    <video id="input-video" playsinline webkit-playsinline></video>
    <canvas id="output-canvas"></canvas>

    <script>
        function log(msg) {
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
            console.log(msg);
        }

        let scene, camera, renderer, labubuGroup;
        let hands, cameraUtils;
        let isFrontCamera = true;
        let isRunning = false;

        const startBtn = document.getElementById('start-btn');
        const switchBtn = document.getElementById('switch-btn');
        const statusDiv = document.getElementById('loading-status');
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');

        // 1. èµ„æºæ£€æµ‹
        window.onload = function() {
            log("é¡µé¢è½½å…¥ã€‚æ£€æŸ¥ä¾èµ–...");
            let missing = [];
            if (typeof THREE === 'undefined') missing.push("Three.js");
            if (typeof Hands === 'undefined') missing.push("MediaPipe");

            if (missing.length > 0) {
                log(`âŒ ç¼ºå¤±åº“: ${missing.join(', ')}`);
                statusDiv.innerText = "èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°";
                statusDiv.style.color = "red";
            } else {
                log("âœ… æ‰€æœ‰åº“åŠ è½½æˆåŠŸ (å›½å†…æº)");
                startBtn.disabled = false;
                startBtn.innerText = "ç‚¹å‡»å¼€å§‹ä½“éªŒ";
                statusDiv.innerText = "å‡†å¤‡å°±ç»ª";
            }
        };

        // 2. å¯åŠ¨æµç¨‹
        async function startApp() {
            startBtn.disabled = true;
            statusDiv.innerText = "æ­£åœ¨åˆå§‹åŒ– 3D å¼•æ“...";
            
            try {
                // åˆ†æ­¥æ‰§è¡Œå¹¶æ‰“å°æ—¥å¿—ï¼Œçœ‹çœ‹åˆ°åº•å¡åœ¨å“ªä¸€æ­¥
                log(">>> å¼€å§‹åˆå§‹åŒ– Three.js");
                
                if (!canvasElement) throw new Error("æ‰¾ä¸åˆ° Canvas å…ƒç´ ");
                
                log("1. åˆ›å»ºåœºæ™¯...");
                scene = new THREE.Scene();
                
                log("2. åˆ›å»ºç›¸æœº...");
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                
                log("3. åˆ›å»ºæ¸²æŸ“å™¨ (WebGL)...");
                // å¢åŠ  failIfMajorPerformanceCaveat é¿å…æŸäº›æ‰‹æœºå¡æ­»
                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvasElement, 
                    alpha: true, 
                    antialias: true,
                    failIfMajorPerformanceCaveat: false
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                log("âœ… æ¸²æŸ“å™¨åˆ›å»ºæˆåŠŸ");

                log("4. æ·»åŠ ç¯å…‰...");
                scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                scene.add(dirLight);

                log("5. åˆ›å»ºæ¨¡å‹ç»„...");
                labubuGroup = new THREE.Group();
                scene.add(labubuGroup);

                // æµ‹è¯•æ–¹å—
                const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                const material = new THREE.MeshNormalMaterial();
                const cube = new THREE.Mesh(geometry, material);
                labubuGroup.add(cube);
                labubuGroup.visible = false; 
                log("âœ… 3D åˆå§‹åŒ–å®Œæˆï¼");

                // åˆå§‹åŒ– AI
                statusDiv.innerText = "æ­£åœ¨å¯åŠ¨ AI...";
                initMediaPipe();
                
                // å¯åŠ¨ç›¸æœº
                statusDiv.innerText = "è¯·æ±‚æ‘„åƒå¤´...";
                await startCamera('user');

                // å…¨éƒ¨æˆåŠŸ
                document.getElementById('overlay').style.display = 'none';
                switchBtn.style.display = 'block';
                isRunning = true;

            } catch (e) {
                log(`âŒ å´©æºƒ: ${e.message}`);
                statusDiv.innerText = "æŠ¥é”™äº†: " + e.message;
                statusDiv.style.color = "red";
                startBtn.disabled = false;
                alert("åˆå§‹åŒ–å¤±è´¥: " + e.message);
            }
        }

        function initMediaPipe() {
            log(">>> åˆå§‹åŒ– MediaPipe");
            hands = new Hands({locateFile: (file) => {
                // è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¨³å®šçš„æº
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // æ”¹ä¸º 0 (Liteæ¨¡å‹) æé«˜é€Ÿåº¦ï¼Œå‡å°‘å¡é¡¿
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            hands.onResults(onResults);
        }

        async function startCamera(facingMode) {
            log(`>>> å¯åŠ¨ç›¸æœº: ${facingMode}`);
            if (cameraUtils) await cameraUtils.stop();

            if (facingMode === 'user') {
                videoElement.style.transform = "scaleX(-1)";
                canvasElement.style.transform = "scaleX(-1)";
            } else {
                videoElement.style.transform = "scaleX(1)";
                canvasElement.style.transform = "scaleX(1)";
            }

            cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720,
                facingMode: facingMode
            });
            await cameraUtils.start();
            log("âœ… ç›¸æœºæµå·²è·å–");
        }

        switchBtn.addEventListener('click', async () => {
            if (!isRunning) return;
            switchBtn.disabled = true;
            switchBtn.innerText = "...";
            isFrontCamera = !isFrontCamera;
            try {
                await startCamera(isFrontCamera ? 'user' : 'environment');
            } catch(e) { log("åˆ‡æ¢å¤±è´¥" + e); }
            switchBtn.disabled = false;
            switchBtn.innerText = isFrontCamera ? "ğŸ“· åˆ‡åˆ°åç½®" : "ğŸ“· åˆ‡åˆ°å‰ç½®";
        });

        function onResults(results) {
            if (!renderer || !labubuGroup) return;

            // æ¸…ç©ºç”»å¸ƒ
            renderer.clear(); 
            // æ³¨æ„ï¼šè¿™é‡Œåªæ¸²æŸ“3Dï¼ŒèƒŒæ™¯ç”±videoæ ‡ç­¾è´Ÿè´£ï¼Œä¸å†ç”¨canvas drawImageï¼Œæé«˜æ€§èƒ½

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const palmX = landmarks[9].x; 
                const palmY = landmarks[9].y;
                update3DPosition(palmX, palmY, landmarks);
                labubuGroup.visible = true;
            } else {
                labubuGroup.visible = false;
            }
            renderer.render(scene, camera);
        }

        function update3DPosition(x, y, landmarks) {
            const vec = new THREE.Vector3();
            vec.set((x * 2) - 1, -(y * 2) + 1, 0.5);
            vec.unproject(camera);
            vec.sub(camera.position).normalize();
            
            const dx = landmarks[0].x - landmarks[9].x;
            const dy = landmarks[0].y - landmarks[9].y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            const depthFactor = isFrontCamera ? 5 : 8;
            const zDepth = 1 / (dist * depthFactor); 
            
            var dir = vec.multiplyScalar(zDepth);
            labubuGroup.position.copy(camera.position).add(dir);
            labubuGroup.rotation.x += 0.02;
            labubuGroup.rotation.y += 0.02;
        }

        startBtn.addEventListener('click', startApp);
        
        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
