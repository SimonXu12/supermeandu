<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labubu AR ä½“éªŒ (æ•´åˆç‰ˆ)</title>
    
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: sans-serif; }

        /* --- é»˜è®¤çš„ WebXR æ¨¡å¼ --- */
        model-viewer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background-color: black; /* ç¡®ä¿èƒŒæ™¯æ˜¯é»‘çš„ï¼Œå¦åˆ™é€æ˜æ—¶æ˜¾ç¤ºçš„æ˜¯é¡µé¢åº•å±‚ */
            z-index: 10;
        }
        /* model-viewer é»˜è®¤ AR æŒ‰é’® */
        .ar-button {
            background-color: #ff5959; border-radius: 25px; border: none;
            color: white; position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%); padding: 15px 30px; font-size: 16px;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; display: none; /* é»˜è®¤éšè—ï¼Œæœ‰ AR æ‰æ˜¾ç¤º */
        }
        model-viewer[ar-status="session-started"] > .ar-button { display: none; } /* AR å¯åŠ¨åéšè— */

        /* --- æ‰‹æŒè·Ÿéšæ¨¡å¼çš„ UI --- */
        #hand-ar-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* é»˜è®¤éšè— */
            background-color: black;
            z-index: 20; /* æ¯” model-viewer é«˜ */
        }
        #hand-ar-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #hand-ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; transform: scaleX(-1); }
        
        /* åˆ‡æ¢æ¨¡å¼æŒ‰é’® */
        #toggle-mode-btn {
            position: absolute; top: 20px; left: 20px; z-index: 101;
            background: rgba(0, 0, 0, 0.6); color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
            backdrop-filter: blur(5px); display: block; cursor: pointer;
        }

        /* æ‰‹æŒ AR æ¨¡å¼çš„åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’® */
        #hand-ar-switch-cam-btn {
            position: absolute; top: 20px; right: 20px; z-index: 101;
            background: rgba(0, 0, 0, 0.6); color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
            backdrop-filter: blur(5px); display: none; cursor: pointer;
        }
        /* æ¨¡å¼é€‰æ‹©é®ç½© */
        #mode-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        #mode-overlay h1 { margin-bottom: 30px; }
        #mode-overlay button {
            padding: 15px 30px; margin: 10px; font-size: 16px; border-radius: 25px;
            border: none; background-color: #007bff; color: white; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: background-color 0.3s;
        }
        #mode-overlay button:hover { background-color: #0056b3; }
        #mode-overlay button#mode-hand-ar { background-color: #28a745; }
        #mode-overlay button#mode-hand-ar:hover { background-color: #218838; }

        /* è°ƒè¯•æ—¥å¿— */
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 120px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0)); 
            color: #00ff00; font-size: 10px; padding: 10px; 
            overflow-y: scroll; z-index: 102; pointer-events: none;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="mode-overlay">
        <h1>é€‰æ‹© Labubu AR æ¨¡å¼</h1>
        <p style="margin-bottom: 20px; opacity: 0.8;">è¯·é€‰æ‹©ä½ æƒ³ä½“éªŒçš„ AR æ–¹å¼</p>
        <button id="mode-ground-ar">ğŸŒ åœ°é¢å›ºå®šæ¨¡å¼ (æ›´ç¨³å®š)</button>
        <button id="mode-hand-ar">âœ‹ æ‰‹æŒè·Ÿéšæ¨¡å¼ (æ›´äº’åŠ¨)</button>
        <p id="mode-selection-status" style="margin-top: 20px; font-size: 13px; color: #aaa;"></p>
    </div>

    <model-viewer 
        id="ground-ar-viewer"
        src="https://raw.githubusercontent.com/yannluo/labubu-ar/main/labubu.glb" 
        ios-src="https://raw.githubusercontent.com/yannluo/labubu-ar/main/labubu.usdz"
        alt="Labubu 3D æ¨¡å‹"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        shadow-intensity="1"
        touch-action="pan-y">
        <button slot="ar-button" class="ar-button">å¬å”¤ Labubu åˆ°ç°å®ä¸–ç•Œ</button>
        <div slot="progress-bar" style="text-align: center; padding-top: 20px; color: #eee;">æ­£åœ¨åŠ è½½æ¨¡å‹...</div>
    </model-viewer>

    <div id="hand-ar-container">
        <video id="hand-ar-video" playsinline webkit-playsinline></video>
        <canvas id="hand-ar-canvas"></canvas>
        <button id="hand-ar-switch-cam-btn">ğŸ“· åˆ‡åˆ°åç½®</button>
    </div>

    <div id="debug-log">System Ready.</div>

    <script>
        // --- æ—¥å¿—å·¥å…· ---
        function log(msg) {
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
            logDiv.scrollTop = 0; // ä¿æŒæœ€æ–°æ—¥å¿—åœ¨é¡¶éƒ¨
            console.log(msg);
        }

        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, labubuGroupHand; // ç”¨äºæ‰‹æŒAR
        let hands, cameraUtils; // ç”¨äºæ‰‹æŒAR
        let isFrontCameraHand = true; // æ‰‹æŒARæ¨¡å¼ä¸‹çš„æ‘„åƒå¤´çŠ¶æ€
        let isHandARRunning = false; // æ ‡è¯†æ‰‹æŒARæ˜¯å¦å·²å¯åŠ¨

        const modeOverlay = document.getElementById('mode-overlay');
        const modeGroundArBtn = document.getElementById('mode-ground-ar');
        const modeHandArBtn = document.getElementById('mode-hand-ar');
        const modeSelectionStatus = document.getElementById('mode-selection-status');

        const groundArViewer = document.getElementById('ground-ar-viewer');
        const handArContainer = document.getElementById('hand-ar-container');
        const handArVideo = document.getElementById('hand-ar-video');
        const handArCanvas = document.getElementById('hand-ar-canvas');
        const handArSwitchCamBtn = document.getElementById('hand-ar-switch-cam-btn');

        // --- æ¨¡å¼é€‰æ‹©å¤„ç† ---
        modeGroundArBtn.addEventListener('click', () => {
            modeOverlay.style.display = 'none';
            groundArViewer.style.display = 'block';
            log("é€‰æ‹©äº†åœ°é¢å›ºå®š AR æ¨¡å¼ã€‚");
            modeSelectionStatus.innerText = "è¯·ç‚¹å‡»ä¸‹æ–¹çº¢è‰²æŒ‰é’®å¬å”¤ Labubu";
            checkGroundARSupport();
        });

        modeHandArBtn.addEventListener('click', () => {
            modeOverlay.style.display = 'none';
            handArContainer.style.display = 'block';
            log("é€‰æ‹©äº†æ‰‹æŒè·Ÿéš AR æ¨¡å¼ã€‚");
            initHandAR();
        });

        // --- æ£€æŸ¥ WebXR æ”¯æŒæ€§ ---
        function checkGroundARSupport() {
            if (groundArViewer.classList.contains('webxr-error')) {
                modeSelectionStatus.innerText = "å½“å‰è®¾å¤‡ä¸æ”¯æŒåœ°é¢ ARï¼Œå»ºè®®åˆ‡æ¢åˆ°æ‰‹æŒè·Ÿéšæ¨¡å¼ã€‚";
                modeSelectionStatus.style.color = 'orange';
            } else if (!groundArViewer.has<ctrl61>Attribute('ar')) {
                modeSelectionStatus.innerText = "model-viewer åˆå§‹åŒ–ä¸­...";
            }
        }
        
        // model-viewer åŠ è½½å®Œæˆäº‹ä»¶
        groundArViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'not-supported') {
                log("WebXR (åœ°é¢ AR) ä¸å—å½“å‰è®¾å¤‡/æµè§ˆå™¨æ”¯æŒã€‚");
                modeGroundArBtn.disabled = true;
                modeGroundArBtn.innerText = "ä¸æ”¯æŒåœ°é¢ AR";
                modeGroundArBtn.style.backgroundColor = '#6c757d';
                modeSelectionStatus.innerText = "å½“å‰è®¾å¤‡ä¸æ”¯æŒåœ°é¢ ARï¼Œå»ºè®®é€‰æ‹©æ‰‹æŒè·Ÿéšæ¨¡å¼ã€‚";
                groundArViewer.classList.add('webxr-error'); // æ ‡è®°ä¸ºä¸æ”¯æŒ
            } else if (event.detail.status === 'failed') {
                log("WebXR å¯åŠ¨å¤±è´¥ï¼š" + event.detail.error);
                modeSelectionStatus.innerText = "åœ°é¢ AR å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ›´æ–°ç³»ç»Ÿæˆ–æµè§ˆå™¨ã€‚";
                modeSelectionStatus.style.color = 'red';
            } else if (event.detail.status === 'ready') {
                log("WebXR (åœ°é¢ AR) å‡†å¤‡å°±ç»ªã€‚");
                modeSelectionStatus.innerText = "è¯·ç‚¹å‡»ä¸‹æ–¹çº¢è‰²æŒ‰é’®ï¼Œå°† Labubu æ”¾ç½®åˆ°ç°å®ç©ºé—´ã€‚";
            }
        });

        // --- æ‰‹æŒè·Ÿéš AR åˆå§‹åŒ–å’Œè¿è¡Œé€»è¾‘ ---
        async function initHandAR() {
            if (isHandARRunning) return; // é˜²æ­¢é‡å¤åˆå§‹åŒ–

            log(">>> å¯åŠ¨æ‰‹æŒè·Ÿéš AR æ¨¡å¼");
            const loadingText = document.createElement('div');
            loadingText.id = 'hand-ar-loading';
            loadingText.style.cssText = `
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                color: white; font-size: 16px; text-align: center; z-index: 103;
            `;
            loadingText.innerText = "æ­£åœ¨åŠ è½½ AI æ¨¡å‹å’Œå¯åŠ¨æ‘„åƒå¤´...";
            handArContainer.appendChild(loadingText);

            try {
                // åˆå§‹åŒ– Three.js
                log("1. åˆå§‹åŒ– 3D åœºæ™¯...");
                const canvasCtx = handArCanvas.getContext('2d');
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                renderer = new THREE.WebGLRenderer({ canvas: handArCanvas, alpha: true, antialias: true, failIfMajorPerformanceCaveat: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                scene.add(dirLight);

                log("2. åŠ è½½ Labubu æ¨¡å‹...");
                labubuGroupHand = new THREE.Group();
                scene.add(labubuGroupHand);
                
                // ä½¿ç”¨é»˜è®¤çš„ Labubu æ¨¡å‹ (æ³¨æ„ï¼šè¿™æ˜¯æˆ‘æ”¾åˆ° GitHub ä¸Šçš„ GLB æ–‡ä»¶ï¼Œç¡®ä¿è·¯å¾„å¯è®¿é—®)
                const loader = new THREE.GLTFLoader();
                loader.load('https://raw.githubusercontent.com/yannluo/labubu-ar/main/labubu.glb', (gltf) => {
                    const model = gltf.scene;
                    model.scale.set(0.2, 0.2, 0.2); // è°ƒæ•´å¤§å°ï¼Œè®©å®ƒèƒ½æ”¾åœ¨æ‰‹ä¸Š
                    model.position.y = -0.5; // ç¨å¾®å¾€ä¸‹ç§»ï¼Œçœ‹èµ·æ¥ååœ¨æ‰‹æŒä¸­å¤®
                    labubuGroupHand.add(model);
                    labubuGroupHand.visible = false; // é»˜è®¤éšè—
                    log("âœ… Labubu æ¨¡å‹åŠ è½½æˆåŠŸ");
                }, undefined, (error) => {
                    log("âŒ Labubu æ¨¡å‹åŠ è½½å¤±è´¥: " + error);
                    loadingText.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
                });
                
                // åˆå§‹åŒ– MediaPipe
                log("3. åˆå§‹åŒ– AI è§†è§‰...");
                hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 0, // Lite æ¨¡å‹æé«˜é€Ÿåº¦
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                hands.onResults(onHandARResults);

                // å¯åŠ¨æ‘„åƒå¤´
                log("4. å¯åŠ¨æ‘„åƒå¤´...");
                await startHandCamera('user');
                
                isHandARRunning = true;
                handArContainer.removeChild(loadingText);
                handArSwitchCamBtn.style.display = 'block'; // æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
                log("âœ… æ‰‹æŒ AR æ¨¡å¼å¯åŠ¨æˆåŠŸï¼ä¼¸å‡ºæ‰‹è¯•è¯•ã€‚");

            } catch (e) {
                log("âŒ æ‰‹æŒ AR å¯åŠ¨å¤±è´¥: " + e.message);
                loadingText.innerText = "å¯åŠ¨å¤±è´¥: " + e.message + "ã€‚è¯·åˆ·æ–°é‡è¯•ã€‚";
            }
        }

        // å¯åŠ¨æ‰‹æŒ AR æ¨¡å¼çš„æ‘„åƒå¤´
        async function startHandCamera(facingMode) {
            log(`å¯åŠ¨æ‰‹æŒARæ‘„åƒå¤´: ${facingMode}`);
            if (cameraUtils) {
                await cameraUtils.stop();
            }

            // è°ƒæ•´é•œåƒCSS
            handArVideo.style.transform = (facingMode === 'user') ? "scaleX(-1)" : "scaleX(1)";
            handArCanvas.style.transform = (facingMode === 'user') ? "scaleX(-1)" : "scaleX(1)";
            
            cameraUtils = new Camera(handArVideo, {
                onFrame: async () => {
                    await hands.send({image: handArVideo});
                },
                width: 1280,
                height: 720,
                facingMode: facingMode
            });
            await cameraUtils.start();
            log("âœ… æ‰‹æŒARæ‘„åƒå¤´æµè·å–æˆåŠŸ");
        }

        // æ‰‹æŒ AR æ¨¡å¼çš„æ¸²æŸ“å¾ªç¯
        function onHandARResults(results) {
            if (!renderer || !labubuGroupHand || !camera) return;

            // MediaPipe å†…éƒ¨ä¼šæ¸²æŸ“èƒŒæ™¯è§†é¢‘åˆ° videoElementï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨ canvas ç»˜åˆ¶
            // renderer åªè´Ÿè´£æ¸²æŸ“ 3D æ¨¡å‹

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const wrist = landmarks[0]; // æ‰‹è…•
                const middleFingerBase = landmarks[9]; // ä¸­æŒ‡æ ¹éƒ¨

                // ä½¿ç”¨æ‰‹è…•å’Œä¸­æŒ‡æ ¹éƒ¨æ¥å®šä½æ‰‹æŒä¸­å¿ƒ
                const handCenterX = (wrist.x + middleFingerBase.x) / 2;
                const handCenterY = (wrist.y + middleFingerBase.y) / 2;
                
                updateLabubuPositionOnHand(handCenterX, handCenterY, landmarks);
                labubuGroupHand.visible = true;

            } else {
                labubuGroupHand.visible = false;
            }
            renderer.render(scene, camera);
        }

        // æ›´æ–° Labubu åœ¨æ‰‹ä¸Šçš„ä½ç½®å’Œæ—‹è½¬
        function updateLabubuPositionOnHand(x, y, landmarks) {
            const vec = new THREE.Vector3();
            vec.set((x * 2) - 1, -(y * 2) + 1, 0.5); // å±å¹•åæ ‡è½¬ NDC
            vec.unproject(camera); // NDC è½¬ä¸–ç•Œåæ ‡
            vec.sub(camera.position).normalize();
            
            // æ·±åº¦ä¼°ç®—ï¼šæ ¹æ®æ‰‹æŒå¤§å°è°ƒæ•´ Z è½´æ·±åº¦
            const dx = landmarks[0].x - landmarks[9].x;
            const dy = landmarks[0].y - landmarks[9].y;
            const handSize = Math.sqrt(dx*dx + dy*dy); // æ‰‹è…•åˆ°ä¸­æŒ‡æ ¹çš„è·ç¦»
            const depthFactor = isFrontCameraHand ? 5 : 8; // å‰ç½®/åç½®æ·±åº¦ç³»æ•°
            const zDepth = 1 / (handSize * depthFactor) * 2; // è°ƒæ•´ä¹˜æ•°è®©æ¨¡å‹è¿‘ä¸€ç‚¹

            const dir = vec.multiplyScalar(zDepth);
            labubuGroupHand.position.copy(camera.position).add(dir);

            // è®©æ¨¡å‹è·Ÿéšæ‰‹æŒçš„æ—‹è½¬
            // å¯ä»¥é€šè¿‡æ‰‹è…•ï¼ˆ0ï¼‰å’Œé£ŸæŒ‡æ ¹éƒ¨ï¼ˆ5ï¼‰æ¥è®¡ç®—æ‰‹çš„å·¦å³å€¾æ–œ
            const wrist = landmarks[0];
            const indexFingerBase = landmarks[5];
            const handAngle = Math.atan2(indexFingerBase.y - wrist.y, indexFingerBase.x - wrist.x);
            
            // ç®€å•çš„æ¨¡å‹æ—‹è½¬ï¼Œè®©å®ƒçœ‹èµ·æ¥åå¾—æ›´ç¨³
            labubuGroupHand.rotation.z = handAngle + Math.PI / 2; // +90åº¦è®©æ¨¡å‹å¤´éƒ¨æœä¸Š
            labubuGroupHand.rotation.x = -Math.PI / 8; // ç¨å¾®å¾€å‰å€¾ä¸€ç‚¹
        }

        // æ‰‹æŒ AR æ¨¡å¼ä¸‹çš„åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®
        handArSwitchCamBtn.addEventListener('click', async () => {
            if (!isHandARRunning) return;
            handArSwitchCamBtn.disabled = true;
            handArSwitchCamBtn.innerText = "åˆ‡æ¢ä¸­...";
            isFrontCameraHand = !isFrontCameraHand;
            try {
                await startHandCamera(isFrontCameraHand ? 'user' : 'environment');
            } catch(e) { log("æ‰‹æŒARæ‘„åƒå¤´åˆ‡æ¢å¤±è´¥: " + e); }
            handArSwitchCamBtn.disabled = false;
            handArSwitchCamBtn.innerText = isFrontCameraHand ? "ğŸ“· åˆ‡åˆ°åç½®" : "ğŸ“· åˆ‡åˆ°å‰ç½®";
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®
        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
