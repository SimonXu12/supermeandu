<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labubu æ‰‹æŒ AR (ä¿®å¤ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* è§†é¢‘å±‚ & Canvaså±‚ */
        #input-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; opacity: 1; }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        
        /* å¯åŠ¨ç•Œé¢å®¹å™¨ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }

        /* å¯åŠ¨æŒ‰é’® */
        #start-btn {
            padding: 15px 30px; font-size: 18px; background: #ff5959; color: white;
            border: none; border-radius: 25px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 89, 89, 0.5);
            margin-bottom: 20px;
        }

        /* è°ƒè¯•æ—¥å¿— (æ˜¾ç¤ºæŠ¥é”™ä¿¡æ¯) */
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 150px;
            background: rgba(0,0,0,0.5); color: lime; font-size: 12px;
            padding: 10px; overflow-y: scroll; z-index: 101; pointer-events: none;
            box-sizing: border-box;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

    <div id="overlay">
        <h2>ğŸ‘‹ Labubu AR</h2>
        <p style="margin-bottom: 20px; opacity: 0.8;">è¯·ç¡®ä¿åœ¨æ˜äº®çš„ç¯å¢ƒä¸‹ä½¿ç”¨</p>
        <button id="start-btn">ç‚¹å‡»å¼€å§‹ä½“éªŒ</button>
        <div id="status-text" style="margin-top: 15px; font-size: 14px; color: #aaa;">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div id="debug-log">System Ready.</div>

    <video id="input-video" playsinline webkit-playsinline></video>
    <canvas id="output-canvas"></canvas>

    <script>
        // --- æ—¥å¿—è¾…åŠ©å‡½æ•° (æŠŠæŠ¥é”™æ‰“åœ¨å±å¹•ä¸Š) ---
        function log(msg) {
            console.log(msg);
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
        }
        
        window.onerror = function(msg, source, lineno) {
            log(`âŒ Error: ${msg} (Line ${lineno})`);
        }

        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const overlay = document.getElementById('overlay');

        // --- Three.js åˆå§‹åŒ– ---
        let scene, camera, renderer, labubuGroup;

        function initThreeJS() {
            try {
                log("æ­£åœ¨åˆå§‹åŒ– 3D å¼•æ“...");
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;

                renderer = new THREE.WebGLRenderer({ canvas: canvasElement, alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                scene.add(dirLight);

                labubuGroup = new THREE.Group();
                scene.add(labubuGroup);

                // >>> çº¢æ–¹å—æµ‹è¯•ä½“ <<<
                const geometry = new THREE.BoxGeometry(1.5, 2, 1);
                const material = new THREE.MeshLambertMaterial({ color: 0xff5959 });
                const cube = new THREE.Mesh(geometry, material);
                labubuGroup.add(cube);
                labubuGroup.visible = false;

                log("3D å¼•æ“å‡†å¤‡å°±ç»ª");
            } catch (e) {
                log("âŒ ThreeJS åˆå§‹åŒ–å¤±è´¥: " + e.message);
            }
        }

        // --- MediaPipe åˆå§‹åŒ– ---
        let hands, cameraUtils;

        function initMediaPipe() {
            log("æ­£åœ¨åŠ è½½ AI æ¨¡å‹ (æ–‡ä»¶è¾ƒå¤§è¯·è€å¿ƒç­‰å¾…)...");
            statusText.innerText = "æ­£åœ¨ä¸‹è½½ AI æ¨¡å‹ (çº¦ 10MB)...";

            hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);
            log("AI æ¨¡å‹é…ç½®å®Œæˆ");
        }

        function onResults(results) {
            // ä¸€æ—¦æœ‰ç»“æœè¿”å›ï¼Œè¯´æ˜è·‘é€šäº†ï¼Œéšè—é®ç½©
            if (overlay.style.display !== 'none') {
                overlay.style.display = 'none';
                log("âœ… è§†è§‰ç³»ç»Ÿè¿è¡Œä¸­ï¼è¯·ä¼¸å‡ºæ‰‹ã€‚");
            }

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            // æ³¨æ„ï¼šè¿™é‡Œä¸å†ç»˜åˆ¶ image åˆ° canvasï¼Œå› ä¸º video å·²ç»åœ¨åº•å±‚æ˜¾ç¤ºäº†ï¼Œä¸ºäº†èŠ‚çœæ€§èƒ½
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const palmX = landmarks[9].x; // ä¸­æŒ‡æ ¹éƒ¨
                const palmY = landmarks[9].y;
                
                updateLabubuPosition(palmX, palmY, landmarks);
                labubuGroup.visible = true;
            } else {
                labubuGroup.visible = false;
            }

            // æ¸²æŸ“ 3D
            renderer.render(scene, camera);
            canvasCtx.restore();
        }

        function updateLabubuPosition(x, y, landmarks) {
            const vec = new THREE.Vector3();
            const pos = new THREE.Vector3();
            
            vec.set((x * 2) - 1, -(y * 2) + 1, 0.5);
            vec.unproject(camera);
            vec.sub(camera.position).normalize();
            
            const dx = landmarks[0].x - landmarks[9].x;
            const dy = landmarks[0].y - landmarks[9].y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            const zDepth = 1 / (distance * 5); 
            
            var dir = vec.multiplyScalar(zDepth);
            labubuGroup.position.copy(camera.position).add(dir);
            labubuGroup.lookAt(camera.position);
        }

        // --- ç‚¹å‡»å¼€å§‹æµç¨‹ ---
        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.innerText = "å¯åŠ¨ä¸­...";
            statusText.innerText = "æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...";
            
            initThreeJS();
            initMediaPipe();

            try {
                log("å°è¯•å¯åŠ¨æ‘„åƒå¤´...");
                cameraUtils = new Camera(videoElement, {
                    onFrame: async () => {
                        await hands.send({image: videoElement});
                    },
                    width: 1280,
                    height: 720
                });
                
                await cameraUtils.start();
                log("æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼ç­‰å¾… AI è¯†åˆ«...");
                statusText.innerText = "æ‘„åƒå¤´å·²æ‰“å¼€ï¼Œæ­£åœ¨å¤„ç†ç”»é¢...";
                
            } catch (error) {
                log("âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + error.message);
                statusText.innerText = "æŠ¥é”™äº†ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—";
                alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿åœ¨è®¾ç½®ä¸­å…è®¸æµè§ˆå™¨è®¿é—®ç›¸æœºï¼Œå¹¶ä½¿ç”¨ HTTPS é“¾æ¥ã€‚");
                startBtn.disabled = false;
                startBtn.innerText = "é‡è¯•";
            }
        });

        window.addEventListener('resize', () => {
            if(camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
