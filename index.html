<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labubu AR (ä¿®å¤åŠ è½½å™¨)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #input-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        /* UI */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #switch-btn {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            background: rgba(0, 0, 0, 0.5); color: white; border: 1px solid white;
            padding: 8px 16px; border-radius: 20px; font-size: 14px; display: none;
        }
        #debug {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.6); color: lime; font-size: 12px;
            padding: 10px; overflow-y: scroll; pointer-events: none; box-sizing: border-box;
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 20; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #00C853; color: white;
            border: none; border-radius: 30px; font-weight: bold; margin-top: 20px; cursor: pointer;
        }
        #start-btn:disabled { background: #555; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="overlay">
        <h1>ğŸ‘‹ Labubu AR</h1>
        <div id="status">æ­£åœ¨è¿æ¥èµ„æºæœåŠ¡å™¨...</div>
        <button id="start-btn" disabled>åŠ è½½ä¸­...</button>
    </div>

    <div id="ui-container">
        <button id="switch-btn">ğŸ“· åˆ‡æ¢é•œå¤´</button>
        <div id="debug"></div>
    </div>

    <video id="input-video" playsinline webkit-playsinline></video>
    <canvas id="output-canvas"></canvas>

    <script type="module">
        // å¯¼å…¥ Three.js å’Œ Loader
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // æ—¥å¿—
        function log(msg) {
            const d = document.getElementById('debug');
            if(d) d.innerHTML = `> ${msg}<br>` + d.innerHTML;
            console.log(msg);
        }

        // å˜é‡
        let camera, scene, renderer, labubuGroup;
        let hands, cameraUtils;
        let isFrontCamera = true;
        
        const videoElement = document.getElementById('input-video');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status');
        const overlay = document.getElementById('overlay');
        const switchBtn = document.getElementById('switch-btn');

        // é¡µé¢åŠ è½½æ£€æŸ¥
        window.onload = () => {
            if(typeof Hands === 'undefined') {
                statusText.innerText = "AI åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°";
                statusText.style.color = 'red';
            } else {
                statusText.innerText = "èµ„æºå°±ç»ª";
                startBtn.innerText = "ç‚¹å‡»å¯åŠ¨";
                startBtn.disabled = false;
            }
        };

        // å¯åŠ¨æŒ‰é’®
        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.innerText = "å¯åŠ¨ä¸­...";
            
            try {
                initThree();
                initAI();
                await startCamera('user');
                
                overlay.style.display = 'none';
                switchBtn.style.display = 'block';
                log("âœ… ç³»ç»Ÿå¯åŠ¨æˆåŠŸ");
            } catch (e) {
                log("âŒ é”™è¯¯: " + e.message);
                alert("å¯åŠ¨å‡ºé”™: " + e.message);
                startBtn.disabled = false;
            }
        });

        // åˆå§‹åŒ– 3D
        function initThree() {
            log("åˆå§‹åŒ– 3D å¼•æ“...");
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            const canvas = document.getElementById('output-canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 1);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(2, 5, 5);
            scene.add(dirLight);

            labubuGroup = new THREE.Group();
            scene.add(labubuGroup);

            // åŠ è½½æ¨¡å‹ (ä½¿ç”¨ GitHub Pages é“¾æ¥ï¼Œæˆ–è€…æ”¹æˆ './labubu.glb')
            log("åŠ è½½æ¨¡å‹...");
            const loader = new GLTFLoader();
            const modelUrl = 'https://raw.githubusercontent.com/yannluo/labubu-ar/main/labubu.glb'; 
            
            loader.load(
                modelUrl, 
                (gltf) => {
                    const model = gltf.scene;
                    model.scale.set(0.3, 0.3, 0.3);
                    model.position.y = -0.5;
                    labubuGroup.add(model);
                    log("âœ… æ¨¡å‹åŠ è½½æˆåŠŸ!");
                }, 
                undefined, 
                (error) => {
                    log("âš ï¸ æ¨¡å‹ä¸‹è½½å¤±è´¥ï¼ŒåŠ è½½çº¢è‰²æ–¹å—ä»£æ›¿");
                    const box = new THREE.Mesh(
                        new THREE.BoxGeometry(1,1,1), 
                        new THREE.MeshNormalMaterial()
                    );
                    labubuGroup.add(box);
                }
            );
        }

        // åˆå§‹åŒ– AI
        function initAI() {
            log("åˆå§‹åŒ– AI...");
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            hands.onResults(onResults);
        }

        // å¯åŠ¨ç›¸æœº
        async function startCamera(mode) {
            log(`å¯åŠ¨ç›¸æœº: ${mode}`);
            if (cameraUtils) await cameraUtils.stop();

            // é•œåƒå¤„ç†
            const scaleX = mode === 'user' ? -1 : 1;
            videoElement.style.transform = `scaleX(${scaleX})`;

            cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720,
                facingMode: mode
            });
            await cameraUtils.start();
        }

        // åˆ‡æ¢æ‘„åƒå¤´
        switchBtn.addEventListener('click', async () => {
            switchBtn.disabled = true;
            isFrontCamera = !isFrontCamera;
            try {
                await startCamera(isFrontCamera ? 'user' : 'environment');
            } catch(e) { log("åˆ‡æ¢å¤±è´¥"); }
            switchBtn.disabled = false;
        });

        // æ¸²æŸ“å¾ªç¯
        function onResults(results) {
            renderer.clear();
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                let x = landmarks[9].x;
                let y = landmarks[9].y;
                
                // å‰ç½®é•œåƒä¿®æ­£
                if (isFrontCamera) x = 1 - x;

                // åæ ‡è½¬æ¢
                const vec = new THREE.Vector3();
                vec.set((x * 2) - 1, -(y * 2) + 1, 0.5);
                vec.unproject(camera);
                vec.sub(camera.position).normalize();

                // æ·±åº¦
                const depthFactor = isFrontCamera ? 5 : 8;
                const dx = landmarks[0].x - landmarks[9].x;
                const dy = landmarks[0].y - landmarks[9].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const distance = 1 / (dist * depthFactor);

                const finalPos = vec.multiplyScalar(distance).add(camera.position);
                labubuGroup.position.copy(finalPos);
                labubuGroup.visible = true;
            } else {
                // æ²¡æ‰‹æ—¶ï¼Œæ˜¾ç¤ºåœ¨ä¸­é—´å¹¶è‡ªè½¬ï¼Œè¯æ˜ç¨‹åºæ²¡æ­»
                labubuGroup.position.set(0, 0, -2); 
                // labubuGroup.visible = true; // æƒ³éšè—å°±æ³¨é‡Šè¿™è¡Œ
                labubuGroup.rotation.y += 0.02;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
