<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labubu AR (æœ€ç»ˆç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #input-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        /* é®ç½©å±‚ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s;
        }

        /* æŒ‰é’® */
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #00C853; color: white;
            border: none; border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4); margin-bottom: 20px;
        }
        #start-btn:disabled { background: #555; color: #888; box-shadow: none; }

        /* è°ƒè¯•æ—¥å¿— */
        #debug-log {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 120px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0)); 
            color: #00ff00; font-size: 11px; padding: 10px; 
            overflow-y: scroll; z-index: 101; pointer-events: none;
            font-family: monospace;
        }
    </style>
    
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

    <div id="overlay">
        <h1>ğŸ‘‹ Labubu AR</h1>
        <div id="loading-status" style="margin: 20px 0; color: #aaa;">æ­£åœ¨é¢„åŠ è½½èµ„æº...</div>
        <button id="start-btn" disabled>èµ„æºåŠ è½½ä¸­...</button>
    </div>

    <div id="debug-log"></div>
    <video id="input-video" playsinline webkit-playsinline></video>
    <canvas id="output-canvas"></canvas>

    <script>
        // æ—¥å¿—å·¥å…·
        function log(msg) {
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
            console.log(msg);
        }

        // å…¨å±€å˜é‡
        let scene, camera, renderer, labubuGroup;
        let hands, cameraUtils;
        const startBtn = document.getElementById('start-btn');
        const statusDiv = document.getElementById('loading-status');

        // --- 1. èµ„æºæ£€æŸ¥ (é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ) ---
        window.onload = function() {
            log("é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ä¾èµ–åº“...");
            
            // æ£€æŸ¥ Three.js æ˜¯å¦æˆåŠŸä¸‹è½½
            if (typeof THREE === 'undefined') {
                log("âŒ è‡´å‘½é”™è¯¯: Three.js å¼•æ“ä¸‹è½½å¤±è´¥ï¼");
                statusDiv.innerText = "ç½‘ç»œé”™è¯¯ï¼šå¼•æ“æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•";
                statusDiv.style.color = "red";
                return;
            }

            // æ£€æŸ¥ MediaPipe
            if (typeof Hands === 'undefined') {
                log("âš ï¸ è­¦å‘Š: AI åº“å¯èƒ½æœªå®Œå…¨åŠ è½½ï¼Œç¨åé‡è¯•...");
            }

            log("âœ… 3D å¼•æ“å°±ç»ªã€‚");
            startBtn.disabled = false;
            startBtn.innerText = "ç‚¹å‡»å¼€å§‹ä½“éªŒ";
            statusDiv.innerText = "å‡†å¤‡å°±ç»ª";
        };

        // --- 2. æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘ ---
        function startApp() {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            startBtn.disabled = true;
            statusDiv.innerText = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´ä¸AI...";

            try {
                // A. åˆå§‹åŒ– 3D åœºæ™¯
                log("åˆå§‹åŒ– 3D åœºæ™¯...");
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;

                renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('output-canvas'), alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                // ç¯å…‰
                scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                scene.add(dirLight);

                // æ¨¡å‹å®¹å™¨
                labubuGroup = new THREE.Group();
                scene.add(labubuGroup);

                // >>> çº¢è‰²æµ‹è¯•æ–¹å— (å¦‚æœä¸æƒ³ç”¨ï¼Œè¯·æ³¨é‡Šæ‰) <<<
                const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                const material = new THREE.MeshNormalMaterial(); // å½©è‰²æè´¨ï¼Œæ›´å®¹æ˜“çœ‹æ¸…
                const cube = new THREE.Mesh(geometry, material);
                labubuGroup.add(cube);
                labubuGroup.visible = false; // é»˜è®¤éšè—
                // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

                /* // >>> å¦‚æœä½ æœ‰ labubu.glbï¼Œå–æ¶ˆæ³¨é‡Šè¿™æ®µä»£ç  <<<
                const loader = new THREE.GLTFLoader();
                loader.load('./labubu.glb', (gltf) => {
                    labubuGroup.clear(); // æ¸…é™¤æ–¹å—
                    const model = gltf.scene;
                    model.scale.set(0.5, 0.5, 0.5); // ç¼©æ”¾
                    labubuGroup.add(model);
                    log("âœ… æ¨¡å‹æ–‡ä»¶åŠ è½½æˆåŠŸ");
                }, undefined, (err) => {
                    log("âŒ æ¨¡å‹åŠ è½½å¤±è´¥: " + err);
                });
                */

                // B. åˆå§‹åŒ– AI æ‰‹éƒ¨è¯†åˆ«
                log("å¯åŠ¨ AI è¯†åˆ«...");
                hands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults(onResults);

                // C. å¯åŠ¨æ‘„åƒå¤´
                const videoElement = document.getElementById('input-video');
                cameraUtils = new Camera(videoElement, {
                    onFrame: async () => {
                        await hands.send({image: videoElement});
                    },
                    width: 1280,
                    height: 720
                });
                
                cameraUtils.start()
                    .then(() => {
                        log("âœ… æ‘„åƒå¤´å·²å¯åŠ¨ï¼");
                        statusDiv.innerText = "è¯·å°†æ‰‹æŒä¼¸åˆ°é•œå¤´å‰...";
                    })
                    .catch(err => {
                        log("âŒ æ‘„åƒå¤´è¢«æ‹’ç»: " + err);
                        alert("æ— æ³•è°ƒç”¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å…è®¸æƒé™ã€‚");
                        startBtn.disabled = false;
                    });

            } catch (e) {
                log("âŒ è¿è¡ŒæŠ¥é”™: " + e.message);
                startBtn.disabled = false;
            }
        }

        // --- 3. æ¯ä¸€å¸§çš„å¤„ç† ---
        function onResults(results) {
            // éšè—é®ç½©
            const overlay = document.getElementById('overlay');
            if (overlay.style.opacity !== '0') {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
            }

            // å¦‚æœ ThreeJS è¿˜æ²¡åˆå§‹åŒ–å¥½ï¼Œç›´æ¥è·³è¿‡ï¼Œé˜²æ­¢æŠ¥é”™
            if (!renderer || !labubuGroup) return;

            // è¯†åˆ«é€»è¾‘
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                // è·å–ä¸­æŒ‡æŒ‡æ ¹ (9)
                const palmX = landmarks[9].x; 
                const palmY = landmarks[9].y;
                
                update3DPosition(palmX, palmY, landmarks);
                labubuGroup.visible = true;
            } else {
                labubuGroup.visible = false;
            }

            renderer.render(scene, camera);
        }

        function update3DPosition(x, y, landmarks) {
            const vec = new THREE.Vector3();
            // åæ ‡è½¬æ¢
            vec.set((x * 2) - 1, -(y * 2) + 1, 0.5);
            vec.unproject(camera);
            vec.sub(camera.position).normalize();
            
            // è·ç¦»ä¼°ç®—
            const dx = landmarks[0].x - landmarks[9].x;
            const dy = landmarks[0].y - landmarks[9].y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const zDepth = 1 / (dist * 5); 
            
            var dir = vec.multiplyScalar(zDepth);
            labubuGroup.position.copy(camera.position).add(dir);
            
            // è®©æ¨¡å‹ç¨å¾®æ—‹è½¬åŠ¨èµ·æ¥ï¼Œå¢åŠ è¶£å‘³
            labubuGroup.rotation.x += 0.01;
            labubuGroup.rotation.y += 0.01;
        }

        // ç»‘å®šæŒ‰é’®
        startBtn.addEventListener('click', startApp);

        // çª—å£é€‚é…
        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
